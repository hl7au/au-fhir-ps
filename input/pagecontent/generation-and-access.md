### Generating & Accessing AU Patient Summary (AU PS) Documents
AU PS is specified in this guide as a HL7 FHIR document (a Bundle including a Composition), composed by a set of potentially reusable "minimal" data blocks (the AU PS profiles). See [Structure of the Australian Patient Summary (AU PS)](general-guidance.html).

As also described in the IPS, it is not in the scope of this version of AU PS to constrain solutions or strategies for the creation, sharing, syntactical and semantic mapping, translation, and use of AU PS Documents or IPS Documents. Options for access and exchange that have been discussed during AU PS meetings are briefly described in this guide with links to the source specifications. While recommendations on operations from IPS on generation are included in this guide, future implementation guides may provide alternative methods and further recommendations different than those outlined. In addition, Integrating the Healthcare Enterprise (IHE) has also published guidance on the IHE Sharing of IPS (sIPS) which may be a helpful reference.

When generating an AU PS Document, implementers are also advised to be familiar with the following IPS guidance:
- [Narrative and Language Translation](https://build.fhir.org/ig/HL7/fhir-ips/Design-Conventions.html#narrative-and-language-translation). 
- [Data Included in IPS Documents](https://build.fhir.org/ig/HL7/fhir-ips/Generation-and-Data-Inclusion.html#data-included-in-ips-documents).

### IPS $summary FHIR operation
The IPS defines the [IPS Summary](https://build.fhir.org/ig/HL7/fhir-ips/OperationDefinition-summary.html) (`$summary`) operation and [IPS Server Capability Statement](https://build.fhir.org/ig/HL7/fhir-ips/CapabilityStatement-ips-server.html), which recommends an IPS Server implement the `$summary` operation as a recommended operation for generating an IPS document.

The `$summary` operation has two endpoint URLs based on the Patient resource:

- `[base]/Patient/$summary` - a Patient resource type endpoint where a patient (business) identifier is provided as a parameter in the operation request body
- `[base]/Patient/[id]/$summary` - a Patient instance endpoint where a patient resource id is provided as a parameter in the URL path

An optional profile parameter can be specified in the request, allowing a server to generate a FHIR document matching the profile requested (e.g. AU Patient Summary). The IPS profile is the default profile generated by the server when a profile parameter is not specified in the request, or when the profile parameter is not supported by the server. 

The `$summary` operation returns a FHIR document Bundle resource containing a Composition resource, and its referenced resources. The returned document may be generated on-demand and represent the latest available patient summary information. It is not expected that the patient summary document is stored as part of the request, therefore this operation does not support use cases where it is required to retrieve a document generated at a previous point in time.

A Patient Summary Consumer can invoke the Patient `$summary` operation on a Patient Summary Server to retrieve an on-demand, system generated patient summary. The operation can also be used internally within a system to generate an initial Patient Summary document that a user can review, curate, assert, display, persist or take further action on.


 <div> 
    <img src="summaryoperation.png" alt="IPS Summary Operation" style="width:45%"/>
  </div>
*Figure 1: The IPS Summary Operation*
<br/>

### IPA $docref FHIR operation
The International Patient Access (IPA) defines the [IPA Fetch DocumentReference](https://hl7.org/fhir/uv/ipa/STU1.1/OperationDefinition-docref.html) (`$docref`) operation. FHIR Release 5 has incorporated the Fetch DocumentReference operation as a core FHIR operation.

The [IPS Server Capability Statement](https://build.fhir.org/ig/HL7/fhir-ips/CapabilityStatement-ips-server.html) identifies the `$docref`operation as an option for an IPS Server to implement for generating an IPS document.

The `$docref` operation has a DocumentReference resource type endpoint that returns a searchset Bundle containing DocumentReference resources that match the specified request parameters.

A Patient Summary Consumer can invoke the `$docref` operation on a server to return all the references to documents related to a patient, but when no parameters other than the mandatory patient resource id are specified, the server will return a single DocumentReference to the patient's most current summary document. The type of this summary document depends on jurisdiction processing rules, such as the Consolidated CDA (C-CDA) commonly used in North America. In the Australian context this could be specified to be an AU PS Bundle. The `$docref` operation expects that a 'summary document' will always exist or can be dynamically generated, but this can be further constrained within a jurisdictional context, the expected operation outcome when a document is missing, including the option to return an empty searchset Bundle.

`$docref` operation parameters include:

- `patient`: required patient resource id
- `start`: care date range end
- `end`: care date range end
- `type`: document type codes
- `profile`: document profile URLs
- `on-demand`: only on-demand documents returned

When optional parameters are provided, the server can return existing documents that match the request parameters. In this manner, the $docref is similar to a DocumentReference search request except a single current summary document is returned if no parameters are provided, or if supported, the on-demand parameter can allow a client to request a new document to be generated and stored. 

The document metadata provided in the return DocumentReference resource can be used to identify a document to be retrieved. The `DocumentReference.content.attachment` element is then used to retrieve the referenced document, which may either be encapsulated within the data  sub-element, or referenced in the url sub-element. The Patient Summary Consumer can retrieve a referenced document Bundle using the FHIR REST API interaction, Bundle read. Other document formats can be retrieved by requesting the resource from the location specified in the `content.attachment.url` element, which may be stored as a FHIR Binary resource.

The `$docref` operation supports several document retrieval use cases, including retrieving a patient summary at previous point in time, a current patient summary and on-demand generation. The benefit of this operation is having a single endpoint to support these multiple scenarios, including other document types and formats such as HL7 CDA and PDF documents. This flexibility suggests that jurisdictional and implementation level profiles may be useful to clearly specify the supported input parameters, document capabilities and output behaviour of the operation. 

<div> 
    <img src="docrefoperation.png" alt="IPA Fetch DocumentReference Operation" style="width:45%"/>
  </div>
*Figure 2: The IPA Fetch DocumentReference Operation*
<br/>

### Document Bundle Interactions
As AU PS is a FHIR Bundle of type document implementers can leverage standard FHIR REST API interactions. The document Bundle can be stored, discovered and retrieved using the REST interactions Create Bundle, Search Bundle and Read Bundle. 

The Bundle search and Bundle read interactions support the use case where a Patient Summary Producer stores the document within this system and wants to provide access to the documents to a Patient Summary Consumer.

The Bundle create interaction supports when a Patient Summary Producer wants to store the document in a separate Patient Summary Server. A Patient Summary Consumer can then access the document using the Bundle search and Bundle read interactions.

A Patient Summary Producer can choose to upload the document directly to the Patient Summary Consumer using the Bundle create interaction so the Consumer can process or view the document. 

<div> 
    <img src="BundleInteractions.png" alt="Document Bundle Interactions" style="width:45%"/>
  </div>
*Figure 3: Document Bundle Interactions*
<br/>

### Named Bundle Search Interaction
A variation on the Bundle search interaction is the use of named query parameter as specified by FHIR. This approach supports advanced query scenarios that require specific and complex query parameters and processing. Named query profiles and parameters are defined using an OperationDefinition. Named search interactions are invoked on resource type or system-wide endpoints, using the _query parameter to provide the query name.

A Bundle search interaction using a named _query parameter may help support commonly used search criteria for multiple patient summary document use cases, however it would not be expected to provide support for on-demand generation of patient summary documents. Name queries will require jurisdictional profiling and custom implementation in requesting and responding systems.

### Document Bundle and DocumentReference Interactions
The FHIR DocumentReference resource provides a generalised method of indexing clinical documents within a electronic medical record system, irrespective of the media type and format of the document. For a Patient Summary document, this approach requires that both the document (Bundle) and the document metadata with a link to the document (DocumentReference) are stored in a consistent manner.  

To ensure data integrity and reliability, a Patient Summary Producer can include a document Bundle resource in a FHIR transaction Bundle resource specifying the request as a create interaction. A DocumentReference resource populated with metadata extracted from the document Bundle and Composition resources, along with a reference to the document Bundle, is also included in the transaction Bundle as a create interaction request. The whole-system (baseUrl) endpoint is used to POST the transaction Bundle to a Patient Summary Server, which ensures both create requests are successful or neither are created.

A Patient Summary Consumer can discover a Patient Summary document using metadata extracted from the document Bundle and Composition resources is supported by a DocumentReference search interaction. The response is a searchset Bundle resource of DocumentReference resources that match the metadata criteria specified in the search parameters.

The Patient Summary Consumer can use the content.attachment.url element value from a selected DocumentReference resource to retrieve a document Bundle from the Patient Summary Server.

A system that produces a Patient Summary document internally can allow a Patient Summary Consumer to discover and retrieve documents using the DocumentReference search and Bundle read interactions as described above.   

<div> 
    <img src="BundleDocRefInteractions.png" alt="Document Bundle and Document Reference Interactions" style="width:45%"/>
  </div>
*Figure 4: Document Bundle and Document Reference Interactions*
<br/>

### IHE MHD Provide Document Bundle 
The Document Bundle and DocumentReference transaction is a simplified profile of the [IHE MHD Provide Document Bundle [ITI-65]](https://profiles.ihe.net/ITI/MHD/ITI-65.html) transaction, which also requires a List resource, providing document set metadata for the documents included in the transaction, to support IHE Cross-enterprise Document Shared (XDS) document repository implementations where multiple documents or document attachments are provided to a document store in a single transaction. This approach is suited to technical implementations based on XDS document repository but requires a Patient Summary Producer to also produce the necessary metadata resources to support this implementation even though there is usual only one Patient Summary document being provided in the transaction.

### IHE MHD Simplified Publish
IHE provides an optional transaction profile, [Simplified Publish [ITI-105]](https://profiles.ihe.net/ITI/MHD/ITI-105.html). This transaction allows a Patient Summary Producer to create a DocumentReference resource with an document Bundle instance that is base64 encoded and populated in `DocumentReference.content.attachment.data`. It is the responsibility of the Patient Summary Producer to populate the metadata of the document in the DocumentReference resource in a way that supports document discover searches.

The Patient Summary Server accepts the DocumentReference resource, extracts and decodes the document Bundle from `DocumentReference.content.attachment.data` and persists Bundle resource. The reference to the Bundle is populated in the `DocumentReference.content.attachment.url`, replacing the `attachment.data` element, and DocumentReference is persisted.

Where the DocumentReference is included in the Create DocumentReference response, the persisted version is returned containing the `DocumentReference.content.attachment.url`. Similarly, search responses containing the DocumentReference will return the `attachment.url` and a Read Bundle request will be required to retrieve the Patient Summary document.

<div> 
    <img src="MHDSimplifiedPublish.png" alt="IHE MHD Simplified Publish" style="width:45%"/>
  </div>
*Figure 5: IHE MHD Simplified Publish*
<br/>

### Encrypted File Exchange
There are scenarios where Patient Summary document exchange is not capable using a FHIR API and trusted user authentication is not available. In these cases, it is necessary to ensure secure exchange of Patient Summary documents as files when using insecure exchange media such as email, USB or DVD.

Public Key Infrastructure (PKI) is an established approach to ensure end to end security of Patient Summary document by encrypting document file being exchanged using the public key of the intended recipient. Once the file is delivered to the intended recipient, the file can be decrypted using the recipient's private key. The decrypted file can then be uploaded into the Patient Summary Consumer system for processing.

<div> 
    <img src="encryptfileexchange.png" alt="Encrypted File Exchange" style="width:45%"/>
  </div>
*Figure 6: Encrypted File Exchange*
<br/>

### SMART Health Links
There are scenarios where Patient Summary document exchange is not capable using a FHIR API and it is unknown who the recipient will be. In this case, it may be desirable to have a method for the Patient or other trusted part to provide a link to the Patient Summary document. [SMART Health Links](https://build.fhir.org/ig/HL7/smart-health-cards-and-links/) is an in progress FHIR implementation guide that supports this use case, but it is necessary that the SMART Health Link itself is secured as it literally contains the key to access the Patient Summary document. 

A user that wants to share a Patient Summary document retrieves a SMART Health Link (SHL) from a SHL Sharing Application. The method of retrieving the SHL is not specified, only the representation of the link which contains encoded data including a URL to retrieve a file manifest, encryption key and description of the link. The user has the option to specify a passcode that will be required to access the file manifest, which is the only authorization challenge to access the Patient Summary document. The SHL may be prefixed with a URL to a SHL Receiving Application to assist in the retrieval and processing of the Patient Summary, and this full URL can be encoded as a QR code to aid in the exchange of the SHL.

When the Receiving User submits the SHL to the SHL Receiving Application, the decoded data from the link, along with the passcode provided by the Sharing User, is used to retrieve the manifest file from the SHL Sharing Application.  The returned manifest contains a set of files, with either a location URL to the file or embedded file data. When the file is retrieved or decoded, the file is then decrypted using the key encoded in the SHL.  The decrypted file contains the Patient Summary document Bundle resource, which can then be processed by the SHL Receiving Application.

<div> 
    <img src="SMARTHealthLinks.png" alt="SMART Health Links Patient Summary Exchange" style="width:45%"/>
  </div>
*Figure 7: SMART Health Links Patient Summary Exchange*
<br/>

